# Database Schema & Data Flow Specification

## 1. Overview

This schema is designed for a Stock Analysis Platform. It handles user authentication, portfolio tracking, market data caching (to reduce API calls), and AI analysis logging.

## 2. Entities (Tables)

### A. Users (用户表)

*Stores authentication and global settings.*

- `id`: UUID (Primary Key)
- `email`: String(255) (Unique, Index)
- `hashed_password`: String
- `is_active`: Boolean (Default: True)
- `membership_tier`: Enum('FREE', 'PRO') (Default: 'FREE')
- `api_key_gemini`: String (Encrypted using Fernet/AES)
- `api_key_deepseek`: String (Encrypted using Fernet/AES)
- `created_at`: DateTime
- `last_login`: DateTime

### B. Stocks (股票基础信息表)

*Normalization table to avoid storing "Apple Inc." repeatedly.*

- `ticker`: String(20) (Primary Key, e.g., "NVDA")
- `name`: String(255) (e.g., "NVIDIA Corporation")
- `sector`: String(100) (Optional, for categorization)
- `exchange`: String(50) (e.g., "NASDAQ", "SSE")
- `currency`: String(10) (e.g., "USD", "CNY")

### C. Portfolios (持仓表)

*Links Users to Stocks with position details.*

- `id`: UUID (Primary Key)
- `user_id`: UUID (Foreign Key -> [Users.id](http://users.id/))
- `ticker`: String (Foreign Key -> Stocks.ticker)
- `quantity`: Float (Number of shares held)
- `avg_cost`: Float (Average buy price)
- `target_price`: Float (Optional, user set goal)
- `stop_loss_price`: Float (Optional)
- `created_at`: DateTime
- `updated_at`: DateTime
- *Constraint:* Unique constraint on (user_id, ticker) -> One record per stock per user.

### D. MarketDataCache (行情缓存表)

*Critical for performance. Stores the latest fetch result to prevent API rate limiting.*

- `ticker`: String (Foreign Key -> Stocks.ticker, Primary Key)
- `current_price`: Float
- `change_percent`: Float (Daily change)
- `rsi_14`: Float (Technical Indicator)
- `ma_20`: Float (Technical Indicator)
- `volume_ratio`: Float (Abnormal volume detection)
- `market_status`: Enum('PRE_MARKET', 'OPEN', 'AFTER_HOURS', 'CLOSED')
- `last_updated`: DateTime (Index)
- *Logic:* If `datetime.now() - last_updated < 1 minute`, read this table. Else, fetch external API and update this.

### E. AnalysisReports (AI 分析记录表)

*Stores the history of AI advice. Used for display and usage limit counting.*

- `id`: UUID (Primary Key)
- `user_id`: UUID (Foreign Key -> [Users.id](http://users.id/))
- `ticker`: String (Foreign Key -> Stocks.ticker)
- `input_context_snapshot`: JSON (Stores the price/news data used *at that moment* for the analysis)
- `ai_response_markdown`: Text (The full advice generated by LLM)
- `sentiment_score`: Enum('BULLISH', 'BEARISH', 'NEUTRAL') (Parsed from AI response)
- `model_used`: String (e.g., "gemini-1.5-flash")
- `created_at`: DateTime (Index, used to count daily usage limit)

## 3. Relationships

- **Users** have many **Portfolios**.
- **Users** have many **AnalysisReports**.
- **Stocks** have one **MarketDataCache**.
- **Stocks** are referenced by **Portfolios** and **AnalysisReports**.

## 4. Key Data Flows (Logic for Developer)

### Flow 1: Add Stock to Portfolio

1. Frontend sends `ticker`, `quantity`, `cost`.
2. Backend checks if `ticker` exists in `Stocks` table.
    - If NO: Fetch metadata from yfinance, insert into `Stocks`, create entry in `MarketDataCache`.
    - If YES: Proceed.
3. Insert/Update `Portfolios` table.

### Flow 2: Dashboard Refresh (Smart Caching)

1. Get list of user's tickers from `Portfolios`.
2. For each ticker, check `MarketDataCache.last_updated`.
3. If `now - last_updated > 60 seconds` (or custom interval):
    - Background Task: Fetch new data from `yfinance`.
    - Update `MarketDataCache`.
4. Join `Portfolios` with `MarketDataCache` to calculate Unrealized P&L.
5. Return JSON to Frontend.

### Flow 3: AI Analysis (Quota Management)

1. Count `AnalysisReports` where `user_id = current_user` AND `created_at > today_start`.
2. If count >= 3 AND membership != PRO: Throw 403 Error.
3. Aggregate data (Price + Tech Indicators + User Position).
4. Call LLM API.
5. Save result to `AnalysisReports`.