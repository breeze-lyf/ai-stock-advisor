# 产品需求文档 (PRD) - AI 智能投顾助手 (AI Smart Investment Advisor)

**版本号：** v2.0 (已发布)
**状态：** 生产就绪 (Production Ready)
**核心目标：** 为个人投资者提供基于实时数据与大模型深度分析的辅助决策工具，通过“RAG 数据流 + LLM 深度解读 + 严格风控逻辑”的模式，降低投研门槛。

---

## 1. 产品概述 (Executive Summary)

本产品是一个 Web 端应用，允许用户管理自选股列表，记录持仓成本。系统通过后端 Python 服务（RAG 预处理逻辑）获取实时/盘前股价、技术指标与新闻，用户可触发 AI 分析，获得关于“买卖点、持仓风险、市场情绪”的深度建议。

**核心差异化价值：**

-   **严格风控 (Strict RRR)：** 盈亏比 (Risk/Reward Ratio) 采用“单一真实数据源”逻辑。AI 策略生成的止盈/止损位具有最高优先级，强制覆盖通用技术指标数据，确保交易计划的一致性。
-   **全天候监控 (24/7 Watch)：** 后台自动刷新脚本每 5 分钟轮询“最陈旧”的股票，确保数据永远保持新鲜，无需用户手动干预。
-   **深度整合 (Deep Context)：** AI 分析不仅基于价格，还融合了实时新闻 (Tavily/News API) 和技术指标 (RSI/MACD/Bollinger Bands)，生成包含“市场情绪 + 技术面 + 资金面”的综合报告。

---

## 2. 用户画像 (User Persona)

-   **趋势交易者：** 关注 RSI、MACD 和布林带，寻找突破或回调机会。
-   **上班族：** 没时间盯盘，依赖“AI 早报”和“持仓诊断”来快速决策。
-   **数据驱动型用户：** 喜欢看干净、专业的图表，关注具体的“盈亏比”数值。

---

## 3. 功能需求详情 (Functional Requirements)

### 3.1 账户与权限体系

-   **注册/登录：** JWT 认证体系，支持 Token 自动续期。
-   **API Key 管理 (SaaS)：** 支持多模型配置（Gemini, DeepSeek, Qwen），用户可自定义 API Key，亦可使用系统预设的高级 Key (Pro 会员)。

### 3.2 仪表盘 (Dashboard)

-   **自选股列表：**
    -   **实时行情：** WebSocket/轮询更新价格与涨跌幅。
    -   **迷你图表：** 展示近 24 小时微型走势图。
    -   **智能盈亏比 Badge：**
        -   **AI 策略 (金/蓝色)：** 当 `is_ai_strategy=True` 时，显示 AI 计算的 RRR。
        -   **技术策略 (灰/白色)：** 无 AI 策略时，显示基于 Pivot/MA 的技术面 RRR。
-   **投资组合摘要：**
    -   总资产、总盈亏、当日盈亏实时计算。
    -   **AI 持仓洞察：** 一键生成全持仓的风险对冲建议与行业暴露分析。

### 3.3 股票行情与数据 (Data Layer / RAG Context)

后端通过 Python (`yfinance` 或 `akshare`) 获取数据。

-   **实时性策略：**
    -   页面在前台激活时，每 10-15 秒轮询一次价格。
    -   页面休眠（Tab 切换走）时停止轮询。
    -   提供显著的“手动刷新”按钮。
    -   **盘前/盘后支持：** 必须展示 Pre-market/After-hours 价格，因为美股盘前波动很大。
    -   **交互：** 支持缩放、平移、十字光标、多图表时间轴同步。
    -   **视觉优化：** 移除多余边框与 Logo，采用极简金融风配色。
-   **数据源：**
    -   **美股：** `yfinance` (实时 + 盘前盘后)。
    -   **A股：** `akshare` (实时 + 历史)。
    -   **自动刷新：** 后台守护进程 (`auto_refresh_market_data.py`) 自动维护数据新鲜度。

### 3.4 深度 AI 分析 (The Core)

-   **触发方式：** 详情页点击“⚡️ 深度分析”按钮。
-   **RAG (检索增强生成) 流程：**
    1.  **数据聚合：** 抓取 OHLCV、技术指标 (RSI/MACD)、实时新闻。
    2.  **Prompt 构建：** 注入“专业交易员”人设，要求输出 JSON 格式的结构化交易计划。
    3.  **模型推理：** 调用 DeepSeek-R1 / Gemini-Pro 进行逻辑推演。
    4.  **回写数据库：**
        -   将生成的 `Target Price` (止盈) 和 `Stop Loss` (止损) 写入数据库。
        -   **关键逻辑：** 将该股标记为 `is_ai_strategy=True`，锁定盈亏比计算源。
-   **分析报告结构：**
    -   **交易信号 (Action)：** 强烈买入 / 谨慎持有 / 卖出。
    -   **情绪偏差 (Sentiment)：** 看涨 / 看跌 / 中性 (由新闻与盘面共同决定)。
    -   **主要逻辑 (Key Rationale)：** 3 点核心理由 (Markdown 渲染)。
    -   **交易计划 (Trade Setups)：** 明确的入场位、止损位、目标位。

### 3.5 头寸管理

-   **持仓录入：** 代码、数量、成本价。
-   **自动计算：** 浮动盈亏、持仓占比。
-   **逻辑关联：** AI 分析时会自动读取持仓成本，生成针对性的“解套”或“止盈”建议。

---

## 4. 技术架构 (Technical Architecture)

见 `doc/tech_stack.md` 与 `backend/system_flowchart.md` (系统流程图)。

---

## 5. 核心业务流程 (Core Flows)

1.  **数据摄入：** 用户添加股票 -> 后端异步抓取 (Quote + Fundamentals + History) -> 计算指标 -> 存入 DB。
2.  **数据保鲜：** 用户无操作 -> 后台脚本每 5 分钟轮询 -> 发现“旧”数据 -> 强制刷新。
3.  **决策辅助：** 用户请求分析 -> AI 读取 DB 数据 + 抓取新闻 -> 生成策略 -> **锁定策略状态** (`is_ai_strategy=True`) -> 前端展示“AI 推荐”的高亮盈亏比。

---

## 6. 未来规划 (Roadmap)

### v2.1 (短期)
- [ ] **PostgreSQL 迁移：** 解决 SQLite 并发锁问题，支持更高频的自动刷新。
- [ ] **用户偏好设置：** 允许用户自定义技术指标参数 (如 RSI 周期 14 -> 6)。

### v2.2 (中期)
- [ ] **SaaS 支付集成：** Stripe / 微信支付。
- [ ] **多用户隔离：** 完整的用户体系与数据隔离。

### v3.0 (长期)
- [ ] **本地向量库 (RAG Upgrade)：** 使用 `pgvector` 存储新闻向量，实现“自然语言搜股”。
- [ ] **全自动交易：** 对接券商 API (IBKR/Futu) 实现根据 AI 信号自动下单 (需合规审查)。